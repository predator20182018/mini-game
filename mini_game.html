<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–Ω–∏-–∏–≥—Ä–∞ üéÆ</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
            background-color: #f0f0f0;
            font-family: sans-serif;
        }
        #grid-container {
            width: 100%;
            height: 100%;
            display: grid;
            /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ */
            grid-template-columns: repeat(auto-fill, 20px); /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ, —à–∏—Ä–∏–Ω–∞ 20px */
            grid-template-rows: repeat(auto-fill, 20px);    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ, –≤—ã—Å–æ—Ç–∞ 20px */
            gap: 0; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ */
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–µ—Ç–∫—É */
            align-content: center;  /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–µ—Ç–∫—É */
        }
        .grid-button {
            width: 100%;  /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —è—á–µ–π–∫—É */
            height: 100%;
            background-color: #e0e0e0; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–µ—Ä—ã–π */
            border: none; /* –ë–µ–∑ —Ä–∞–º–∫–∏ */
            padding: 0; /* –ë–µ–∑ –æ—Ç—Å—Ç—É–ø–æ–≤ */
            margin: 0;  /* –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ */
            box-sizing: border-box; /*  */
            cursor: pointer;
            transition: background-color 0.1s; /* –ü–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ */
        }
        .grid-button.my-touch {
            background-color: blue; /* –°–∏–Ω–∏–π –¥–ª—è —Å–≤–æ–∏—Ö –∫–∞—Å–∞–Ω–∏–π */
        }
        .grid-button.other-touch {
            background-color: red;  /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —á—É–∂–∏—Ö –∫–∞—Å–∞–Ω–∏–π */
        }

        #touch-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        #message {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="touch-counter">–ö–∞—Å–∞–Ω–∏–π: 0</div>
    <div id="grid-container"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const gridContainer = document.getElementById('grid-container');
        const touchCounter = document.getElementById('touch-counter');
        const messageElement = document.getElementById('message');

        let touchCount = 0;
        let otherUserId = null;
        let gameStarted = false;
        let myId = null;

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showMessage(text, duration = 3000) {
           messageElement.textContent = text;
           messageElement.style.display = 'block';
           setTimeout(() => {
             messageElement.style.display = 'none';
           }, duration);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
        function updateCounter() {
            touchCounter.textContent = `–ö–∞—Å–∞–Ω–∏–π: ${touchCount}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫
        function createGrid() {
            const cellSize = 20; // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏
            const numCols = Math.floor(window.innerWidth / cellSize);
            const numRows = Math.floor(window.innerHeight / cellSize);

            for (let row = 0; row < numRows; row++) {
                for (let col = 0; col < numCols; col++) {
                    const button = document.createElement('button');
                    button.classList.add('grid-button');
                    button.dataset.row = row; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É
                    button.dataset.col = col; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–æ–ª–±–µ—Ü

                    button.addEventListener('click', handleButtonClick);
                    button.addEventListener('touchstart', handleButtonClick, { passive: false });
                    gridContainer.appendChild(button);
                }
            }
        }


        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
        function handleButtonClick(event) {
           if (!gameStarted) return;
            event.preventDefault();

            const button = event.currentTarget; // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–∂–∞–ª–∏

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∞—Ç –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∫–≤–∞–¥—Ä–∞—Ç–∏–∫
            if (button.classList.contains('my-touch') || button.classList.contains('other-touch')) {
                 return; // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
             }

            button.classList.add('my-touch'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å "my-touch"

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            touchCount++;
            updateCounter();

            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
          // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏ —Å—Ç–æ–ª–±–µ—Ü –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
            const row = parseInt(button.dataset.row);
            const col = parseInt(button.dataset.col);


            tg.sendData(JSON.stringify({ type: 'touch', row, col, otherUserId }));
        }

         // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–∞ (–ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É/—Ç–∞–ø—É)
        let lastTap = 0;
        gridContainer.addEventListener('touchend', (event) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;

            if (tapLength < 300 && tapLength > 0) {
                event.preventDefault();
                 if (!gameStarted) return;

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∫–∞—Å–∞–Ω–∏—è)
                touchCount = 0;
                updateCounter();
                 const myTouches = document.querySelectorAll('.grid-button.my-touch');
                 myTouches.forEach(button => button.classList.remove('my-touch'));
                 myTouches.forEach(button => button.style.backgroundColor = ''); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ü–≤–µ—Ç


                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
            lastTap = currentTime;
        });

          gridContainer.addEventListener('dblclick', (event) => {
            event.preventDefault();
            if (!gameStarted) return;

            touchCount = 0;
            updateCounter();

            const myTouches = document.querySelectorAll('.grid-button.my-touch');
            myTouches.forEach(button => button.classList.remove('my-touch'));
            myTouches.forEach(button => button.style.backgroundColor = '');

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
         tg.onEvent('mainButtonClicked', () => {  //–ò–º–∏—Ç–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç
           if (!gameStarted) {
               tg.sendData(JSON.stringify({ type: 'ready' })); // –°–æ–æ–±—â–∞–µ–º –±–æ—Ç—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
               showMessage("–ò—â–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...")
            }
         });

        if (tg.MainButton) {
             tg.MainButton.text = "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
             tg.MainButton.show();
         } else { //–ò–º–∏—Ç–∞—Ü–∏—è
             tg.onEvent('viewportChanged', () => {  // –ò–º–∏—Ç–∞—Ü–∏—è, –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ—Ç
                if (!gameStarted) {
                  tg.sendData(JSON.stringify({ type: 'ready' }));
                  showMessage("–ò—â–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...");
                }
            });
         }

        tg.onEvent('web_app_data_received', (event) => {
            const data = JSON.parse(event);

            if (data.type === 'start') {
                otherUserId = data.otherUserId;
                myId = data.myId; // –ü–æ–ª—É—á–∞–µ–º —Å–≤–æ–π ID
                gameStarted = true;
                showMessage("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!");

            } else if (data.type === 'touch' && data.userId !== myId) {
               // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å
                const button = document.querySelector(`.grid-button[data-row="${data.row}"][data-col="${data.col}"]`);
                if (button && !button.classList.contains('my-touch') && !button.classList.contains('other-touch')) { //–ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞—Ç –ª–∏ –±—ã–ª —É–∂–µ —ç—Ç–æ—Ç –∫–≤–∞–¥—Ä–∞—Ç–∏–∫
                    button.classList.add('other-touch');
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
                     }
                }
            } else if (data.type === 'disconnect') {
                showMessage("–í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è.", 5000);
                gameStarted = false;
                otherUserId = null;

                //–û—á–∏—â–∞–µ–º –ø–æ–ª–µ –æ—Ç —á—É–∂–∏—Ö –Ω–∞–∂–∞—Ç–∏–π
                const otherTouches = document.querySelectorAll('.grid-button.other-touch');
                otherTouches.forEach(button => button.classList.remove('other-touch')); //–£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å
                otherTouches.forEach(button => button.style.backgroundColor = ''); //–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç

            }
        });

        // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        createGrid();
        tg.expand();
        tg.ready();
    </script>
</body>
</html>