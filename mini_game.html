<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–Ω–∏-–∏–≥—Ä–∞ üéÆ</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: sans-serif;
        }
        #grid-container {
            width: 100%;
            height: 100%;
            display: grid;
            /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ */
            grid-template-columns: repeat(auto-fill, 20px); /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ, —à–∏—Ä–∏–Ω–∞ 20px */
            grid-template-rows: repeat(auto-fill, 20px);    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ, –≤—ã—Å–æ—Ç–∞ 20px */
            gap: 0; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ */
            justify-content: center;
            align-content: center;
        }
        .grid-button {
            width: 100%;
            height: 100%;
            background-color: #e0e0e0; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–µ—Ä—ã–π */
            border: none;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .grid-button.my-touch {
            background-color: blue;
        }
        .grid-button.other-touch {
            background-color: red;
        }

        #touch-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        #message {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="touch-counter">–ö–∞—Å–∞–Ω–∏–π: 0</div>
    <div id="grid-container"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const gridContainer = document.getElementById('grid-container');
        const touchCounter = document.getElementById('touch-counter');
        const messageElement = document.getElementById('message');

        let touchCount = 0;
        let otherUserId = null;
        let gameStarted = false;
        let myId = null;

        function showMessage(text, duration = 3000) {
           messageElement.textContent = text;
           messageElement.style.display = 'block';
           setTimeout(() => {
             messageElement.style.display = 'none';
           }, duration);
        }

        function updateCounter() {
            touchCounter.textContent = `–ö–∞—Å–∞–Ω–∏–π: ${touchCount}`;
        }

        function createGrid() {
            const cellSize = 20;
            const numCols = Math.floor(window.innerWidth / cellSize);
            const numRows = Math.floor(window.innerHeight / cellSize);

            for (let row = 0; row < numRows; row++) {
                for (let col = 0; col < numCols; col++) {
                    const button = document.createElement('button');
                    button.classList.add('grid-button');
                    button.dataset.row = row;
                    button.dataset.col = col;

                    button.addEventListener('click', handleButtonClick);
                    button.addEventListener('touchstart', handleButtonClick, { passive: false });
                    gridContainer.appendChild(button);
                }
            }
        }

        function handleButtonClick(event) {
           if (!gameStarted) return;
            event.preventDefault();

            const button = event.currentTarget;

            if (button.classList.contains('my-touch') || button.classList.contains('other-touch')) {
                 return;
             }

            button.classList.add('my-touch');

            touchCount++;
            updateCounter();

            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            const row = parseInt(button.dataset.row);
            const col = parseInt(button.dataset.col);

            tg.sendData(JSON.stringify({ type: 'touch', row, col, otherUserId }));
        }

        let lastTap = 0;
        gridContainer.addEventListener('touchend', (event) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;

            if (tapLength < 300 && tapLength > 0) {
                event.preventDefault();
                 if (!gameStarted) return;
                touchCount = 0;
                updateCounter();
                 const myTouches = document.querySelectorAll('.grid-button.my-touch');
                 myTouches.forEach(button => button.classList.remove('my-touch'));
                 myTouches.forEach(button => button.style.backgroundColor = '');

                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
            lastTap = currentTime;
        });

          gridContainer.addEventListener('dblclick', (event) => {
            event.preventDefault();
            if (!gameStarted) return;

            touchCount = 0;
            updateCounter();

            const myTouches = document.querySelectorAll('.grid-button.my-touch');
            myTouches.forEach(button => button.classList.remove('my-touch'));
            myTouches.forEach(button => button.style.backgroundColor = '');

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        });


        // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–≥—Ä–µ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
        function startGame() {
             if (!gameStarted) {
                 tg.sendData(JSON.stringify({ type: 'ready' }));
                 showMessage("–ò—â–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...");
              }
        }

        tg.onEvent('web_app_data_received', (event) => {
            const data = JSON.parse(event);

            if (data.type === 'start') {
                otherUserId = data.otherUserId;
                myId = data.myId;
                gameStarted = true;
                showMessage("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!");

            } else if (data.type === 'touch' && data.userId !== myId) {
                const button = document.querySelector(`.grid-button[data-row="${data.row}"][data-col="${data.col}"]`);
                if (button && !button.classList.contains('my-touch') && !button.classList.contains('other-touch')) {
                    button.classList.add('other-touch');
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                     }
                }
            } else if (data.type === 'disconnect') {
                showMessage("–í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è.", 5000);
                gameStarted = false;
                otherUserId = null;
                const otherTouches = document.querySelectorAll('.grid-button.other-touch');
                otherTouches.forEach(button => button.classList.remove('other-touch'));
                otherTouches.forEach(button => button.style.backgroundColor = '');
            }
        });

        createGrid();
        tg.expand();
        tg.ready();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        startGame();

    </script>
</body>
</html>